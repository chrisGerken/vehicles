<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Simulation - Design Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            background-color: #f5f5f5;
            color: #333;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            padding: 20px;
        }
        .toc {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
            height: fit-content;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        .toc h2 {
            font-size: 1.2em;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        .toc ul {
            list-style: none;
        }
        .toc li {
            margin: 8px 0;
        }
        .toc a {
            color: #555;
            text-decoration: none;
            font-size: 0.9em;
            display: block;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .toc a:hover {
            background-color: #f0f0f0;
            color: #667eea;
        }
        .toc .sub {
            padding-left: 15px;
            font-size: 0.85em;
        }
        .content {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin: 40px 0 20px 0;
        }
        h1:first-child {
            margin-top: 0;
        }
        h2 {
            color: #34495e;
            margin-top: 35px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ecf0f1;
        }
        h3 {
            color: #555;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        h4 {
            color: #666;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        p {
            margin: 12px 0;
        }
        code {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            color: #c7254e;
        }
        pre {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            overflow-x: auto;
            margin: 15px 0;
        }
        pre code {
            border: none;
            padding: 0;
            background-color: transparent;
            color: #333;
        }
        ul, ol {
            padding-left: 25px;
            margin: 12px 0;
        }
        li {
            margin: 6px 0;
        }
        strong {
            color: #2c3e50;
        }
        .property-list {
            background-color: #f9f9f9;
            padding: 15px;
            border-left: 4px solid #667eea;
            margin: 15px 0;
        }
        .method-list {
            background-color: #f9f9f9;
            padding: 15px;
            border-left: 4px solid #3498db;
            margin: 15px 0;
        }
        .note {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
        }
        .example {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #667eea;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        hr {
            border: none;
            border-top: 2px solid #ecf0f1;
            margin: 40px 0;
        }
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            .toc {
                position: static;
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Simulation Business Objects</h1>
        <p>Design Documentation for Vehicle Simulation System</p>
    </div>

    <div class="container">
        <nav class="toc">
            <h2>Contents</h2>
            <ul>
                <li><a href="#business-objects">Business Objects</a></li>
                <li><a href="#architecture">System Architecture</a></li>
                <li><a href="#tech-stack">Technology Stack</a></li>
                <li><a href="#project-structure">Project Structure</a></li>
                <li><a href="#physics">Physics and Movement</a></li>
                <li><a href="#neural-network">Neural Network Evaluation</a></li>
                <li><a href="#lifecycle">Simulation Lifecycle</a></li>
                <li><a href="#species-examples">Example Species</a></li>
                <li><a href="#validation">Validation Rules</a></li>
                <li><a href="#error-handling">Error Handling</a></li>
            </ul>
        </nav>

        <main class="content">
            <section id="business-objects">
                <h1>Simulation Business Objects</h1>

                <h2 id="arena">Arena</h2>
                <div class="property-list">
                    <h4>Properties:</h4>
                    <ul>
                        <li><code>width: double</code> - Width in simulation units</li>
                        <li><code>height: double</code> - Height in simulation units</li>
                        <li><code>wrapEastWest: boolean</code> - Whether east/west edges wrap (toroidal)</li>
                        <li><code>wrapNorthSouth: boolean</code> - Whether north/south edges wrap (toroidal)</li>
                        <li><code>backgroundColor: Color</code> - Background color for rendering</li>
                    </ul>
                </div>
                <div class="method-list">
                    <h4>Methods:</h4>
                    <ul>
                        <li><code>normalizePosition(x, y): Point</code> - Wraps coordinates if wrapping enabled</li>
                        <li><code>getObjectsInRadius(x, y, radius): List&lt;SimulationObject&gt;</code> - Spatial query</li>
                        <li><code>checkCollision(vehicle): boolean</code> - Check if vehicle hits wall or object</li>
                    </ul>
                </div>

                <h2 id="simulation-object">SimulationObject (Abstract)</h2>
                <div class="property-list">
                    <h4>Properties:</h4>
                    <ul>
                        <li><code>id: String</code> - Unique identifier</li>
                        <li><code>x: double</code> - X coordinate</li>
                        <li><code>y: double</code> - Y coordinate</li>
                        <li><code>colorName: String</code> - Reference to named color definition</li>
                        <li><code>brightness: double</code> - Brightness level (0.0 to 1.0)</li>
                        <li><code>radius: double</code> - Collision radius (0 for point sources)</li>
                    </ul>
                </div>
                <div class="method-list">
                    <h4>Methods:</h4>
                    <ul>
                        <li><code>getBoundingBox(): Rectangle</code> - For collision detection</li>
                        <li><code>distanceTo(other: SimulationObject): double</code> - Distance calculation</li>
                        <li><code>getColor(): Color</code> - Resolves color name to RGB color</li>
                    </ul>
                </div>

                <h2 id="static-simulation-object">StaticSimulationObject</h2>
                <p><strong>Inherits from:</strong> SimulationObject</p>
                <div class="property-list">
                    <h4>Properties:</h4>
                    <ul>
                        <li><code>type: ObjectType</code> - POINT or WALL</li>
                        <li><code>x2: double</code> - End X coordinate (for WALL type only)</li>
                        <li><code>y2: double</code> - End Y coordinate (for WALL type only)</li>
                        <li><code>emitsBrightness: boolean</code> - Whether it's a light source</li>
                    </ul>
                </div>
                <div class="note">
                    <h4>Types:</h4>
                    <ul>
                        <li><strong>POINT:</strong> Point light source at (x, y) with specified radius (can be 0)</li>
                        <li><strong>WALL:</strong> Line segment from (x, y) to (x2, y2)</li>
                    </ul>
                    <h4>Additional Notes:</h4>
                    <ul>
                        <li>Immutable position after creation</li>
                        <li>Can be used as obstacles or light sources for receptors</li>
                        <li>Point sources emit brightness; walls typically used as obstacles</li>
                        <li>Walls can be packaged and reused across simulations</li>
                    </ul>
                </div>

                <h2 id="vehicle">Vehicle</h2>
                <p><strong>Inherits from:</strong> SimulationObject</p>
                <div class="property-list">
                    <h4>Properties:</h4>
                    <ul>
                        <li><code>angle: double</code> - Heading in radians (0 to 2π)</li>
                        <li><code>leftMotorSpeed: double</code> - Left wheel speed (-1.0 to 1.0)</li>
                        <li><code>rightMotorSpeed: double</code> - Right wheel speed (-1.0 to 1.0)</li>
                        <li><code>wheelBase: double</code> - Distance between left and right wheels</li>
                        <li><code>maxSpeed: double</code> - Maximum forward speed</li>
                        <li><code>species: Species</code> - Reference to species definition</li>
                        <li><code>colorName: String</code> - Vehicle-specific color (optional, overrides species color)</li>
                        <li><code>receptors: List&lt;Receptor&gt;</code> - Sensor array (defined by species)</li>
                        <li><code>neuralNetwork: NeuralNetworkInstance</code> - Instance of species neural network</li>
                    </ul>
                </div>
                <div class="method-list">
                    <h4>Methods:</h4>
                    <ul>
                        <li><code>updateMotorSpeeds()</code> - Called after neural network evaluation</li>
                        <li><code>updatePosition(deltaTime)</code> - Physics integration</li>
                        <li><code>sense(): Map&lt;Receptor, double&gt;</code> - Read all receptor values</li>
                        <li><code>getEffectiveColor(): String</code> - Returns vehicle color if set, otherwise species color</li>
                    </ul>
                </div>
                <div class="note">
                    <h4>Additional Notes:</h4>
                    <ul>
                        <li>If species has a color, vehicle inherits it unless vehicle-specific color is set</li>
                        <li>If species has no color, vehicle MUST have its own color specified</li>
                    </ul>
                </div>

                <h2 id="species">Species</h2>
                <div class="property-list">
                    <h4>Properties:</h4>
                    <ul>
                        <li><code>id: String</code> - Unique identifier</li>
                        <li><code>name: String</code> - Human-readable name</li>
                        <li><code>colorName: String</code> - Default color for vehicles (optional)</li>
                        <li><code>receptorDefinitions: List&lt;ReceptorDefinition&gt;</code> - Template for receptors</li>
                        <li><code>neuralNetworkTemplate: NeuralNetworkTemplate</code> - Graph structure</li>
                        <li><code>vehicleRadius: double</code> - Size of vehicles of this species</li>
                        <li><code>wheelBase: double</code> - Wheel separation</li>
                        <li><code>maxSpeed: double</code> - Maximum speed</li>
                        <li><code>sourcePackage: String</code> - Reference to reusable package (optional)</li>
                        <li><code>editable: boolean</code> - Whether this species can be modified (false for package references)</li>
                    </ul>
                </div>
                <div class="method-list">
                    <h4>Methods:</h4>
                    <ul>
                        <li><code>createVehicle(x, y, angle): Vehicle</code> - Instantiate a new vehicle</li>
                        <li><code>createVehicle(x, y, angle, colorName): Vehicle</code> - Instantiate with specific color</li>
                        <li><code>clone(): Species</code> - For mutations/variations</li>
                    </ul>
                </div>
                <div class="note">
                    <h4>Additional Notes:</h4>
                    <ul>
                        <li>Species can be defined inline in a simulation or referenced from a reusable package</li>
                        <li>If colorName is not set, each vehicle must specify its own color</li>
                        <li>Package-referenced species are read-only; clone to create editable variant</li>
                    </ul>
                </div>

                <h2 id="receptor">Receptor</h2>
                <div class="property-list">
                    <h4>Properties:</h4>
                    <ul>
                        <li><code>id: String</code> - Unique identifier</li>
                        <li><code>angleFrom: double</code> - Start angle relative to vehicle heading (0 to 2π)</li>
                        <li><code>angleTo: double</code> - End angle relative to vehicle heading (0 to 2π)</li>
                        <li><code>maxRange: double</code> - Maximum detection distance</li>
                        <li><code>sensitivity: double</code> - Sensitivity multiplier</li>
                        <li><code>colorFilter: String</code> - Only detects objects of this color (named color)</li>
                        <li><code>accumulatedLight: double</code> - Current accumulated light (capacitor charge)</li>
                        <li><code>threshold: double</code> - Light threshold for firing</li>
                        <li><code>willFireNextTick: boolean</code> - Whether receptor will fire on next clock tick</li>
                    </ul>
                </div>
                <div class="method-list">
                    <h4>Methods:</h4>
                    <ul>
                        <li><code>accumulateLight(vehicle, arena): void</code> - Accumulates light from matching-color objects</li>
                        <li><code>checkThreshold(): void</code> - Checks if threshold exceeded, sets willFireNextTick, reduces charge</li>
                        <li><code>reset(): void</code> - Clears fire state for new tick</li>
                    </ul>
                </div>
                <div class="note">
                    <h4>Notes:</h4>
                    <ul>
                        <li>Detects brightness only from objects matching colorFilter</li>
                        <li>Accumulates light: closer objects contribute more (brightness × (1 - distance/maxRange) × sensitivity)</li>
                        <li>When accumulatedLight ≥ threshold: willFireNextTick = true, accumulatedLight -= threshold</li>
                        <li>Fires once per threshold crossing, then charge reduced by threshold amount</li>
                        <li>Acts as capacitor, accumulating light over time until threshold is reached</li>
                    </ul>
                </div>

                <h2 id="neurode">Neurode</h2>
                <div class="property-list">
                    <h4>Properties:</h4>
                    <ul>
                        <li><code>id: String</code> - Unique identifier within network</li>
                        <li><code>type: NeurodeType</code> - INPUT, HIDDEN, OUTPUT</li>
                        <li><code>threshold: int</code> - Number of firing excitatory connections required to fire</li>
                        <li><code>firedPreviousTick: boolean</code> - State from previous clock tick</li>
                        <li><code>willFireNextTick: boolean</code> - Computed state for next clock tick</li>
                        <li><code>inputConnections: List&lt;Connection&gt;</code> - Incoming connections</li>
                        <li><code>outputConnections: List&lt;Connection&gt;</code> - Outgoing connections</li>
                    </ul>
                </div>
                <div class="method-list">
                    <h4>Methods:</h4>
                    <ul>
                        <li><code>evaluate(): void</code> - Computes willFireNextTick based on previous tick states</li>
                        <li><code>advanceTick(): void</code> - Moves willFireNextTick to firedPreviousTick for new tick</li>
                    </ul>
                </div>
                <div class="note">
                    <h4>Types:</h4>
                    <ul>
                        <li><strong>INPUT:</strong> Connected to receptor or constant</li>
                        <li><strong>HIDDEN:</strong> Internal processing</li>
                        <li><strong>OUTPUT:</strong> Controls left/right motor</li>
                    </ul>
                    <h4>Firing Logic:</h4>
                    <ul>
                        <li>Count how many EXCITER input connections fired on previous tick</li>
                        <li>If count ≥ threshold AND no INHIBITOR connections fired on previous tick: willFireNextTick = true</li>
                        <li>Otherwise: willFireNextTick = false</li>
                        <li>No accumulation across ticks; each tick is independent evaluation</li>
                    </ul>
                </div>

                <h2 id="connection">Connection</h2>
                <div class="property-list">
                    <h4>Properties:</h4>
                    <ul>
                        <li><code>id: String</code> - Unique identifier</li>
                        <li><code>fromNeurode: String</code> - Source neurode ID</li>
                        <li><code>toNeurode: String</code> - Destination neurode ID</li>
                        <li><code>type: ConnectionType</code> - INHIBITOR or EXCITER</li>
                        <li><code>weight: double</code> - Connection strength (0.0 to 1.0)</li>
                    </ul>
                </div>
                <div class="note">
                    <h4>Types:</h4>
                    <ul>
                        <li><strong>INHIBITOR:</strong> If source fires, prevents target from firing this tick</li>
                        <li><strong>EXCITER:</strong> If source fires, contributes to target activation</li>
                    </ul>
                </div>

                <h2 id="collision-behavior">CollisionBehavior</h2>
                <div class="property-list">
                    <h4>Properties:</h4>
                    <ul>
                        <li><code>defaultBehavior: CollisionMode</code> - Default collision handling (NONE, BREAK, BOUNCE)</li>
                        <li><code>colorSpecificBehaviors: Map&lt;String, CollisionMode&gt;</code> - Per-color collision rules</li>
                    </ul>
                </div>
                <div class="note">
                    <h4>Collision Modes:</h4>
                    <ul>
                        <li><strong>NONE:</strong> No collision detection; vehicles pass through objects (break at non-wrapping boundaries)</li>
                        <li><strong>BREAK:</strong> Vehicles break (stop/destroy) when colliding with objects</li>
                        <li><strong>BOUNCE:</strong> Vehicles bounce off objects</li>
                    </ul>
                </div>
                <div class="method-list">
                    <h4>Methods:</h4>
                    <ul>
                        <li><code>getBehaviorForColor(colorName): CollisionMode</code> - Returns collision mode for specific color</li>
                        <li><code>setColorBehavior(colorName, mode): void</code> - Configure per-color collision</li>
                    </ul>
                </div>
                <div class="example">
                    <h4>Example:</h4>
                    <pre><code>defaultBehavior: BOUNCE
colorSpecificBehaviors: {
  "blue": BREAK,     // Break blue lights
  "red": NONE        // Pass through red vehicles
}</code></pre>
                </div>
            </section>

            <hr>

            <section id="architecture">
                <h1>System Architecture</h1>

                <h2>Backend (Java)</h2>
                <div class="property-list">
                    <h4>Responsibilities:</h4>
                    <ul>
                        <li>Multi-simulation management (multiple independent simulations)</li>
                        <li>Simulation engine (core logic for each simulation)</li>
                        <li>Physics calculations (vehicle movement, collisions)</li>
                        <li>Neural network processing (neurode firing, signal propagation)</li>
                        <li>Multi-threaded execution (configurable threads per simulation)</li>
                        <li>State management and persistence</li>
                        <li>WebSocket server for real-time updates</li>
                        <li>REST API for configuration and control</li>
                        <li>Package management (loading, saving, sharing species/objects)</li>
                        <li>Embedded Jetty web server</li>
                    </ul>
                </div>

                <h3>Key Components:</h3>
                <ul>
                    <li><code>Application</code>: Main entry point, starts/stops Jetty server</li>
                    <li><code>SimulationManager</code>: Manages multiple concurrent simulations</li>
                    <li><code>SimulationEngine</code>: Main orchestrator for single simulation, clock management</li>
                    <li><code>Arena</code>: World management, spatial indexing for collision detection</li>
                    <li><code>VehicleProcessor</code>: Thread pool for parallel vehicle updates (per simulation)</li>
                    <li><code>NeuralNetworkEvaluator</code>: Processes neurode graphs with wave-based evaluation</li>
                    <li><code>PhysicsEngine</code>: Movement, collision detection with configurable behavior</li>
                    <li><code>WebSocketServer</code>: Broadcasts simulation state to connected clients</li>
                    <li><code>APIController</code>: REST endpoints for control and configuration</li>
                    <li><code>PackageRepository</code>: Loads and manages reusable packages</li>
                    <li><code>PersistenceService</code>: Saves/loads simulations and packages</li>
                </ul>

                <h2>Frontend (JavaScript)</h2>
                <div class="property-list">
                    <h4>Responsibilities:</h4>
                    <ul>
                        <li>Canvas/WebGL rendering of arena and objects</li>
                        <li>User controls (play/pause, speed, step-through)</li>
                        <li>Configuration UI (create species, set parameters)</li>
                        <li>WebSocket client for receiving simulation updates</li>
                        <li>Data visualization (charts, statistics)</li>
                        <li>Export/save functionality</li>
                    </ul>
                </div>

                <h3>Key Components:</h3>
                <ul>
                    <li><code>Renderer</code>: Canvas-based drawing of simulation state</li>
                    <li><code>WebSocketClient</code>: Receives and queues state updates</li>
                    <li><code>UIController</code>: Handles user interactions</li>
                    <li><code>ConfigurationPanel</code>: Species editor, simulation parameters</li>
                    <li><code>StatisticsPanel</code>: Charts and metrics</li>
                </ul>
            </section>

            <hr>

            <section id="tech-stack">
                <h1>Technology Stack</h1>

                <h2>Backend (Java)</h2>
                <div class="property-list">
                    <h4>Runtime:</h4>
                    <ul>
                        <li>Java 11 or higher (for var keyword, modern APIs)</li>
                        <li>Embedded Jetty web server (no external server required)</li>
                    </ul>
                    <h4>Build Tool:</h4>
                    <ul>
                        <li>Maven 3.6+</li>
                        <li>Standard directory structure: <code>src/main/java</code>, <code>src/main/resources</code>, <code>src/test/java</code></li>
                        <li>Creates executable JAR with embedded Jetty</li>
                    </ul>
                    <h4>Key Libraries:</h4>
                    <ul>
                        <li><strong>Gson</strong> - JSON serialization/deserialization</li>
                        <li><strong>Jetty WebSocket</strong> - For real-time communication</li>
                        <li><strong>java.util.concurrent</strong> - Thread pools, concurrent collections</li>
                        <li><strong>SLF4J + Logback</strong> - Logging</li>
                    </ul>
                </div>

                <h2>Frontend (JavaScript)</h2>
                <div class="property-list">
                    <h4>Core:</h4>
                    <ul>
                        <li>Vanilla JavaScript (ES6+) or TypeScript</li>
                        <li>HTML5 Canvas for rendering</li>
                        <li>WebSocket API (native browser support)</li>
                    </ul>
                    <h4>Optional Libraries:</h4>
                    <ul>
                        <li><strong>PixiJS</strong> or <strong>Three.js</strong> - If you need advanced rendering (particles, effects)</li>
                        <li><strong>Chart.js</strong> - For statistics/metrics visualization</li>
                        <li>No heavy frameworks required (React/Vue/Angular not needed)</li>
                    </ul>
                </div>
            </section>

            <hr>

            <section id="project-structure">
                <h1>Project Structure</h1>

                <h2>Backend (Maven/Java)</h2>
                <pre><code>vehicles/
├── pom.xml
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/
│   │   │       └── gerkenip/
│   │   │           └── vehicles/
│   │   │               ├── Application.java          # Main entry point
│   │   │               ├── model/                    # Business objects
│   │   │               ├── engine/                   # Simulation engine
│   │   │               ├── servlet/                  # HTTP endpoints
│   │   │               ├── websocket/                # WebSocket endpoint
│   │   │               ├── service/                  # Business logic
│   │   │               ├── repository/               # Data storage
│   │   │               ├── persistence/              # Save/load functionality
│   │   │               └── util/                     # Utilities
│   │   └── resources/
│   │       ├── logback.xml
│   │       └── packages/
│   │           └── base.vsp
│   └── test/
│       └── java/
├── data/
│   ├── simulations/
│   └── packages/
└── target/
    └── vehicles.jar</code></pre>

                <h2>Frontend (JavaScript)</h2>
                <pre><code>frontend/
├── index.html
├── css/
│   └── style.css
├── js/
│   ├── main.js
│   ├── websocket-client.js
│   ├── api-client.js
│   ├── renderer.js
│   ├── ui-controller.js
│   ├── config-panel.js
│   └── stats-panel.js
└── lib/
    └── chart.min.js</code></pre>
            </section>

            <hr>

            <section id="physics">
                <h1>Physics and Movement</h1>

                <h2>Vehicle Kinematics (Differential Drive)</h2>
                <p>The vehicle uses a <strong>differential drive</strong> model with two independently controlled front wheels:</p>

                <div class="property-list">
                    <h4>Given:</h4>
                    <ul>
                        <li><code>vL</code> = left wheel velocity (motorSpeed × maxSpeed)</li>
                        <li><code>vR</code> = right wheel velocity (motorSpeed × maxSpeed)</li>
                        <li><code>L</code> = wheelBase (distance between left and right wheels)</li>
                        <li><code>dt</code> = deltaTime</li>
                    </ul>
                </div>

                <div class="example">
                    <h4>Calculations per tick:</h4>
                    <pre><code>linearVelocity = (vL + vR) / 2
angularVelocity = (vR - vL) / L

angle = angle + angularVelocity × dt
x = x + linearVelocity × cos(angle) × dt
y = y + linearVelocity × sin(angle) × dt</code></pre>
                </div>

                <div class="note">
                    <h4>Behavior:</h4>
                    <ul>
                        <li>Both motors forward at same speed → straight line</li>
                        <li>Left faster than right → turns right</li>
                        <li>Right faster than left → turns left</li>
                        <li>Motors opposite directions → spins in place</li>
                        <li>Negative speeds → reverse</li>
                    </ul>
                </div>

                <h2>Receptor Sensing (Capacitor Model)</h2>
                <p>Each receptor acts as a <strong>capacitor</strong> that accumulates light over time and fires when a threshold is reached.</p>

                <div class="example">
                    <h4>Capacitor Algorithm (per tick):</h4>
                    <pre><code>1. For each SimulationObject in arena:
   a. Check if object.colorName matches receptor.colorFilter
   b. Calculate relative angle from vehicle to object
   c. Check if angle is within [receptor.angleFrom, receptor.angleTo]
   d. If yes, calculate distance
   e. If distance < receptor.maxRange:
      contribution = object.brightness × (1 - distance/maxRange) × sensitivity
      receptor.accumulatedLight += contribution

2. Check if threshold exceeded:
   if receptor.accumulatedLight >= receptor.threshold:
      receptor.willFireNextTick = true
      receptor.accumulatedLight -= receptor.threshold
   else:
      receptor.willFireNextTick = false</code></pre>
                </div>
            </section>

            <hr>

            <section id="neural-network">
                <h1>Neural Network Evaluation</h1>

                <h2>Wave-Based Synchronous Model</h2>
                <p>The network is evaluated once per clock tick using a <strong>wave-based synchronous update</strong> model where signals propagate through the network in discrete waves.</p>

                <div class="note">
                    <h4>Key Principle:</h4>
                    <p>All neurodes use the <strong>previous tick's firing states</strong> to compute <strong>next tick's firing states</strong>. This creates synchronized waves of activation propagating through the network.</p>
                </div>

                <div class="example">
                    <h4>Evaluation Algorithm:</h4>
                    <pre><code>1. Read sensor inputs
   - For each receptor:
     - receptor.accumulateLight(vehicle, arena)
     - receptor.checkThreshold()

2. Advance tick (synchronous state transition)
   - For each neurode:
     - neurode.firedPreviousTick = neurode.willFireNextTick

3. Evaluate network for next tick
   - For each neurode (HIDDEN and OUTPUT types):
     a. Count firing EXCITER connections from previous tick
     b. Check for INHIBITOR veto
     c. Determine if neurode will fire next tick

4. Read output neurodes
   - leftMotorSpeed = output_left_motor.firedPreviousTick ? 1.0 : 0.0
   - rightMotorSpeed = output_right_motor.firedPreviousTick ? 1.0 : 0.0

5. Apply motor speeds to vehicle</code></pre>
                </div>

                <h2>Handling Cycles and Loops</h2>
                <div class="note">
                    <p>The wave-based synchronous model handles cycles elegantly because:</p>
                    <ul>
                        <li>All neurodes update simultaneously using previous tick states</li>
                        <li>No need for iteration loops or convergence detection</li>
                        <li>Cycles create feedback with 1-tick delay per cycle</li>
                        <li>Predictable, deterministic behavior</li>
                    </ul>
                </div>
            </section>

            <hr>

            <section id="lifecycle">
                <h1>Simulation Lifecycle</h1>

                <h2>Execution Loop</h2>
                <p>Each tick follows this sequence:</p>

                <div class="example">
                    <pre><code>while (simulation.running):
  1. Increment clock tick

  2. SENSE PHASE (parallelizable per vehicle)
     - Query arena for nearby objects
     - Evaluate each receptor
     - Update input neurodes

  3. THINK PHASE (parallelizable per vehicle)
     - Evaluate neural network
     - Read output neurodes
     - Set motor speeds

  4. ACT PHASE (parallelizable per vehicle)
     - Calculate new position/angle
     - Check for collisions
     - Update position

  5. BROADCAST PHASE
     - Serialize current state to JSON
     - Send via WebSocket to clients

  6. SLEEP/THROTTLE
     - Sleep to maintain target ticksPerSecond</code></pre>
                </div>

                <h2>Control Commands</h2>
                <ul>
                    <li><strong>Start/Resume</strong> - Begin execution loop</li>
                    <li><strong>Pause</strong> - Stop execution loop</li>
                    <li><strong>Step</strong> - Execute exactly one tick</li>
                    <li><strong>Reset</strong> - Clear all vehicles, reset clock</li>
                    <li><strong>Speed Control</strong> - Adjust ticksPerSecond</li>
                </ul>
            </section>

            <hr>

            <section id="species-examples">
                <h1>Example Species Definitions</h1>

                <h2>Braitenberg Vehicles</h2>
                <p>Classic Braitenberg vehicles demonstrate how simple neural connections produce complex emergent behaviors.</p>

                <h3>1. Phototrope (Love/Attraction)</h3>
                <p><strong>Behavior:</strong> Approaches light sources</p>
                <div class="note">
                    <h4>Why it works:</h4>
                    <ul>
                        <li>Light on left → right motor speeds up → vehicle turns left toward light</li>
                        <li>Light on right → left motor speeds up → vehicle turns right toward light</li>
                        <li>Result: Vehicle curves toward and slows near light sources</li>
                    </ul>
                </div>

                <h3>2. Photophobe (Fear/Avoidance)</h3>
                <p><strong>Behavior:</strong> Avoids light sources, retreats into darkness</p>
                <div class="note">
                    <h4>Neural Network:</h4>
                    <ul>
                        <li>Left sensor → Left motor (parallel excitation)</li>
                        <li>Right sensor → Right motor (parallel excitation)</li>
                    </ul>
                </div>

                <h3>3. Explorer (Obstacle Avoider)</h3>
                <p><strong>Behavior:</strong> Moves forward, turns away from obstacles</p>
                <div class="note">
                    <h4>Neural Network:</h4>
                    <ul>
                        <li>Front sensors inhibit opposite motors when obstacle detected</li>
                        <li>Bias neurode keeps motors running by default</li>
                    </ul>
                </div>

                <h3>4. Aggressive (Pursuer)</h3>
                <p><strong>Behavior:</strong> Charges at objects, aggressive approach</p>
                <div class="note">
                    <h4>Neural Network:</h4>
                    <ul>
                        <li>Crossed inhibitory connections</li>
                        <li>When target on left, inhibits left motor → turns left aggressively</li>
                    </ul>
                </div>
            </section>

            <hr>

            <section id="validation">
                <h1>Validation Rules and Constraints</h1>

                <h2>Arena Validation</h2>
                <table>
                    <tr>
                        <th>Property</th>
                        <th>Constraint</th>
                        <th>Error Message</th>
                    </tr>
                    <tr>
                        <td>Width/Height</td>
                        <td>100 to 10000 units</td>
                        <td>Arena dimensions must be between 100 and 10000 units</td>
                    </tr>
                    <tr>
                        <td>Background Color</td>
                        <td>Valid hex (#RRGGBB)</td>
                        <td>Invalid color format. Use #RRGGBB</td>
                    </tr>
                </table>

                <h2>Vehicle Validation</h2>
                <table>
                    <tr>
                        <th>Property</th>
                        <th>Constraint</th>
                        <th>Error Message</th>
                    </tr>
                    <tr>
                        <td>Position (x, y)</td>
                        <td>Within arena bounds</td>
                        <td>Vehicle position must be within arena bounds</td>
                    </tr>
                    <tr>
                        <td>Angle</td>
                        <td>0 to 2π radians</td>
                        <td>Invalid angle, must be 0 to 2π radians</td>
                    </tr>
                    <tr>
                        <td>Motor Speeds</td>
                        <td>-1.0 to 1.0</td>
                        <td>Motor speed must be between -1.0 and 1.0</td>
                    </tr>
                    <tr>
                        <td>Radius</td>
                        <td>1 to 100 units</td>
                        <td>Vehicle radius must be between 1 and 100 units</td>
                    </tr>
                </table>

                <h2>Simulation Limits</h2>
                <table>
                    <tr>
                        <th>Limit</th>
                        <th>Maximum</th>
                        <th>Recommended</th>
                    </tr>
                    <tr>
                        <td>Vehicles per simulation</td>
                        <td>10,000</td>
                        <td>1,000</td>
                    </tr>
                    <tr>
                        <td>Static objects</td>
                        <td>1,000</td>
                        <td>100</td>
                    </tr>
                    <tr>
                        <td>Species definitions</td>
                        <td>100</td>
                        <td>20</td>
                    </tr>
                    <tr>
                        <td>Neurodes per network</td>
                        <td>1,000</td>
                        <td>50</td>
                    </tr>
                    <tr>
                        <td>Connections per network</td>
                        <td>5,000</td>
                        <td>200</td>
                    </tr>
                </table>
            </section>

            <hr>

            <section id="error-handling">
                <h1>Error Handling Strategy</h1>

                <h2>HTTP Status Codes</h2>
                <div class="property-list">
                    <h4>Success Codes:</h4>
                    <ul>
                        <li><code>200 OK</code> - Successful GET, PUT, or DELETE</li>
                        <li><code>201 Created</code> - Successful POST (entity created)</li>
                        <li><code>204 No Content</code> - Successful DELETE with no response body</li>
                    </ul>
                    <h4>Client Error Codes:</h4>
                    <ul>
                        <li><code>400 Bad Request</code> - Validation failure, malformed JSON</li>
                        <li><code>404 Not Found</code> - Resource doesn't exist</li>
                        <li><code>409 Conflict</code> - Operation conflicts with current state</li>
                        <li><code>422 Unprocessable Entity</code> - Valid JSON but semantically incorrect</li>
                        <li><code>429 Too Many Requests</code> - Exceeded rate limits or entity limits</li>
                    </ul>
                    <h4>Server Error Codes:</h4>
                    <ul>
                        <li><code>500 Internal Server Error</code> - Unexpected error in simulation engine</li>
                        <li><code>503 Service Unavailable</code> - Server overloaded or shutting down</li>
                    </ul>
                </div>

                <h2>Error Response Structure</h2>
                <div class="example">
                    <pre><code>{
  "error": true,
  "errorCode": "VALIDATION_ERROR",
  "message": "Validation failed for vehicle creation",
  "details": [
    {
      "field": "x",
      "value": 12000,
      "error": "Vehicle position must be within arena bounds (0-1000)"
    }
  ],
  "timestamp": "2025-01-04T10:30:45.123Z",
  "path": "/api/vehicles"
}</code></pre>
                </div>

                <h2>Recovery Strategies</h2>
                <div class="note">
                    <h4>Automatic Recovery:</h4>
                    <ul>
                        <li><strong>Invalid Vehicle State:</strong> Reset to last valid position if NaN/infinite</li>
                        <li><strong>Neural Network Instability:</strong> Reset neurode charge to 0 if infinite</li>
                        <li><strong>Resource Exhaustion:</strong> Queue new ticks until threads available</li>
                    </ul>
                    <h4>Manual Recovery:</h4>
                    <ul>
                        <li>Stop simulation</li>
                        <li>Step through tick-by-tick to debug</li>
                        <li>Remove problematic vehicles or species</li>
                        <li>Reset simulation to known good state</li>
                    </ul>
                </div>
            </section>
        </main>
    </div>
</body>
</html>
